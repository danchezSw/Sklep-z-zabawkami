@using System.Globalization
@model ToyStore.Model.DataModels.Product
@using Microsoft.AspNetCore.Identity
@inject UserManager<ToyStore.Model.DataModels.User> UserManager

@functions {
    string ColorToCss(string color)
    {
        return color switch
        {
            "Niebieski" => "#0000ff",
            "Różowy" => "#ff69b4",
            "Żółty" => "#ffff00",
            "Fioletowy" => "#800080",
            "Czerwony" => "#ff0000",
            "Zielony" => "#008000",
            "Szary" => "#808080",
            "Biały" => "#ffffff",
            "Czarny" => "#000000",
            _ => "#ccc"
        };
    }
}

@{
    ViewData["Title"] = Model.Name;
    var plCulture = new CultureInfo("pl-PL");
}

<style>
    .color-swatch {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid #ccc;
        cursor: pointer;
        transition: transform 0.2s, border-color 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .color-swatch:hover {
        transform: scale(1.1);
        border-color: #007bff;
    }

    .color-swatch.active {
        border-color: #007bff; 
        box-shadow: 0 0 0 3px rgba(0,123,255,0.25); 
        transform: scale(1.1);
    }
</style>

<div class="container my-5">
    <div class="row">
        <div class="col-md-6 mb-4 text-center">
            <div class="card shadow-sm border-0">
                <img id="productImage" 
                     src="@(Model.DefaultImageUrl ?? "/images/no-image.png")" 
                     class="img-fluid rounded" 
                     alt="@Model.Name" 
                     style="max-height: 500px; object-fit: contain; width: 100%;">
            </div>
        </div>

        <div class="col-md-6">
            <h1 class="display-5 fw-bold">@Model.Name</h1>
            <p class="text-muted">Kategoria: @(Model.Category?.Name ?? "Brak")</p>
            
            <h3 class="text-success my-3">
                <span id="productPrice">@Model.Price.ToString("0.00")</span> zł
            </h3>

            <div class="my-4">
                <h5 class="border-bottom pb-2">Opis produktu</h5>
                <p class="lead" style="font-size: 1rem; line-height: 1.6;">
                    @Model.Description
                </p>
            </div>

            <form asp-controller="Cart" asp-action="AddToCart" method="post" class="mt-4">
                <input type="hidden" name="productId" value="@Model.Id" />
                <input type="hidden" name="colorVariantId" id="selectedVariantId" value="@(Model.ColorVariants.FirstOrDefault()?.Id ?? 0)" />

                @if (Model.ColorVariants.Any())
                {
                    <div class="mb-4">
                        <label class="form-label fw-bold d-block mb-2">Wybierz wariant:</label>
                        <div class="d-flex gap-2 flex-wrap">
                            @{
                                var firstVariant = Model.ColorVariants.First();
                            }
                            @foreach (var variant in Model.ColorVariants)
                            {
                                var activeClass = variant.Id == firstVariant.Id ? "active" : "";
                                <div class="color-swatch @activeClass"
                                     title="@variant.Color"
                                     style="background-color:@ColorToCss(variant.Color);"
                                     data-variant="@variant.Id"
                                     data-img="@(variant.ImageUrl ?? Model.DefaultImageUrl ?? "/images/no-image.png")"
                                     data-price="@(variant.Price?.ToString("0.00") ?? Model.Price.ToString("0.00"))">
                                </div>
                            }
                        </div>
                    </div>
                }

                <div class="d-flex gap-3 align-items-center mt-3">
                    <input type="number" name="quantity" value="1" min="1" class="form-control" style="width: 80px;" />
                    <button type="submit" class="btn btn-primary btn-lg px-4">
                        Do koszyka <i class="bi bi-cart-plus"></i>
                    </button>
                </div>
            </form>

            <div class="mt-5">
                <a asp-action="Index" class="text-decoration-none text-muted">
                    &larr; Wróć do listy produktów
                </a>
            </div>
        </div>
    </div>

    <hr class="my-5" />

    <div class="row">
        <div class="col-12">
            <h3 class="mb-4">Komentarze</h3>

            <div class="mb-5">
                @{
                    var comments = ViewBag.Comments as List<ToyStore.Model.DataModels.Comment>;
                    var currentUser = await UserManager.GetUserAsync(User);
                }

                @if (comments != null && comments.Any())
                {
                    foreach (var comment in comments)
                    {
                        <div class="card mb-3 border-0 shadow-sm" style="background-color: #f8f9fa;">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h6 class="fw-bold text-primary mb-0">
                                            <i class="bi bi-person-circle"></i> 
                                            @(comment.User?.UserName ?? "Użytkownik")
                                        </h6>
                                        <small class="text-muted" style="font-size: 0.85rem;">
                                            @comment.CreatedDate.ToString("dd.MM.yyyy HH:mm")
                                        </small>
                                    </div>

                                    @if (currentUser != null && (comment.UserId == currentUser.Id || User.IsInRole("Admin")))
                                    {
                                        <form asp-action="DeleteComment" method="post" onsubmit="return confirm('Czy na pewno chcesz usunąć ten komentarz?');">
                                            <input type="hidden" name="commentId" value="@comment.Id" />
                                            <button type="submit" class="btn btn-sm text-danger border-0 bg-transparent" title="Usuń komentarz">
                                                <i class="bi bi-trash"></i> Usuń
                                            </button>
                                        </form>
                                    }
                                </div>
                                <p class="card-text mt-1">@comment.Text</p>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted">Brak opinii o tym produkcie. Bądź pierwszy!</p>
                }
            </div>

            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Dodaj opinię</h5>

                    @if (User.Identity.IsAuthenticated)
                    {
                        <form asp-action="AddComment" method="post">
                            <input type="hidden" name="productId" value="@Model.Id" />
                            <div class="mb-3">
                                <textarea name="text" class="form-control" rows="3" placeholder="Napisz, co sądzisz o tej zabawce..." required></textarea>
                            </div>
                            <button type="submit" class="btn btn-success">Wyślij opinię</button>
                        </form>
                    }
                    else
                    {
                        <div class="alert alert-warning text-center">
                            Aby dodać komentarz, musisz być zalogowany.
                        </div>
                        <div class="text-center">
                            <a href="javascript:void(0);" class="btn btn-outline-primary" data-auth="login">
                                <i class="bi bi-box-arrow-in-right"></i> Zaloguj się
                            </a>
                            <a href="javascript:void(0);" class="btn btn-link" data-auth="register">
                                Zarejestruj się
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const imgElement = document.getElementById("productImage");
            const variantInput = document.getElementById("selectedVariantId");
            const priceElement = document.getElementById("productPrice");
            const swatches = document.querySelectorAll(".color-swatch");

            if (swatches.length > 0) {
                swatches.forEach(swatch => {
                    swatch.addEventListener("click", () => {
                        const img = swatch.dataset.img;
                        const variantId = swatch.dataset.variant;
                        const price = swatch.dataset.price;

                        if (img) {
                            imgElement.src = img;
                        }

                        if (variantId) {
                            variantInput.value = variantId;
                        }

                        if (price) {
                            priceElement.textContent = price.replace('.', ','); 
                        }

                        swatches.forEach(s => s.classList.remove("active"));
                        swatch.classList.add("active");
                    });
                });
            }
        });
    </script>
}