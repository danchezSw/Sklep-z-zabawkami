@model ToyStore.Web.Controllers.ProductModel

@{
    ViewData["Title"] = Model.Title;
    string initialImage = Url.Content(Model.DefaultImage);
}

<div class="container mt-4">
    <h2 class="text-center mb-4">@Model.Title</h2>

    <div class="row">
        <div class="col-md-6 text-center">
            <img id="productImage" src="@initialImage" class="img-fluid rounded shadow" style="max-height: 350px;" />
        </div>

        <div class="col-md-6">
            @* Kolory jeśli są *@
            @if (Model.Colors != null && Model.Colors.Count > 0)
            {
                <h4>Wybierz kolor:</h4>
                <div class="d-flex gap-2 flex-wrap mb-3">
                    @{
                        var firstColorKey = Model.Colors.Keys.First();
                    }
                    @foreach (var color in Model.Colors)
                    {
                        var activeClass = color.Key == firstColorKey ? "active" : "";
                        <div class="color-swatch @activeClass" title="@color.Key"
                             style="background-color:@color.Key;"
                             data-img="@Url.Content("~/images/" + color.Value)"
                             data-color="@color.Key">
                        </div>
                    }
                </div>
            }

            <form asp-controller="Shop" asp-action="AddToCart" method="post" class="mt-3">
                @Html.AntiForgeryToken()
                <input type="hidden" name="name" value="@Model.Title" />
                <input type="hidden" name="image" id="selectedImage" value="@initialImage" />
                <input type="hidden" name="color" id="selectedColor"
                       value="@(Model.Colors?.Keys.FirstOrDefault() ?? "")" />
                <input type="hidden" name="price" value="@Model.Price" />

                <div class="mt-3">
                    <label for="quantity" class="form-label">Ilość:</label>
                    <input type="number" id="quantity" name="quantity"
                           class="form-control" value="1" min="1" style="width:120px;" />
                </div>

                <button type="submit" class="btn btn-success btn-lg mt-3">
                    Dodaj do koszyka
                </button>
            </form>
        </div>
    </div>

    <hr class="my-4" />

    <h3>Opinie klientów</h3>
    <p id="averageRating">Średnia ocena: 0 / 5</p>
    <ul class="list-group mb-4" id="reviewsList">
    </ul>

    <h4>Dodaj opinię</h4>
    <form id="reviewForm">
        <div class="mb-3">
            <label for="AuthorName" class="form-label">Imię</label>
            <input type="text" id="AuthorName" class="form-control" required />
        </div>

        <div class="mb-3">
            <label for="Rating" class="form-label">Ocena (1–5)</label>
            <select id="Rating" class="form-select">
                @for (var i = 1; i <= 5; i++)
                {
                    <option value="@i">@i</option>
                }
            </select>
        </div>

        <div class="mb-3">
            <label for="Content" class="form-label">Treść opinii</label>
            <textarea id="Content" class="form-control" rows="4" required></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Dodaj opinię</button>
    </form>
</div>

@section Scripts {
    <script>
        // Obsługa wyboru koloru
        const imgElement = document.getElementById("productImage");
        const selectedImageInput = document.getElementById("selectedImage");
        const selectedColorInput = document.getElementById("selectedColor");

        document.querySelectorAll(".color-swatch").forEach(swatch => {
            swatch.addEventListener("click", () => {
                const img = swatch.dataset.img;
                const color = swatch.dataset.color;
                imgElement.src = img;
                selectedImageInput.value = img;
                selectedColorInput.value = color;

                document.querySelectorAll(".color-swatch").forEach(s => s.classList.remove("active"));
                swatch.classList.add("active");
            });
        });

        // --- Opinie dynamiczne ---
        let reviews = [];

        function renderReviews() {
            const list = document.getElementById("reviewsList");
            list.innerHTML = "";
            let total = 0;
            reviews.forEach(r => {
                total += r.Rating;
                const li = document.createElement("li");
                li.className = "list-group-item review-item";
                li.innerHTML = `<strong>${r.AuthorName}</strong> <span class="text-warning">${"★".repeat(r.Rating)}${"☆".repeat(5-r.Rating)}</span><br/>
                                <small class="text-muted">${new Date(r.CreatedAt).toLocaleString()}</small>
                                <p class="mb-0">${r.Content}</p>`;
                list.appendChild(li);
            });
            const avg = reviews.length ? (total / reviews.length).toFixed(1) : 0;
            document.getElementById("averageRating").textContent = "Średnia ocena: " + avg + " / 5";
        }

        document.getElementById("reviewForm").addEventListener("submit", function(e){
            e.preventDefault();
            const author = document.getElementById("AuthorName").value;
            const rating = parseInt(document.getElementById("Rating").value);
            const content = document.getElementById("Content").value;

            reviews.push({ AuthorName: author, Rating: rating, CreatedAt: new Date().toISOString(), Content: content });
            renderReviews();

            this.reset(); // Czyści formularz
        });

        renderReviews();
    </script>
}
